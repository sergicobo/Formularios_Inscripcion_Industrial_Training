<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>Ficha Inscripción - Industrial Training</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #000000;
            --muted: #6b7280;
            --accent: #f3ae00;
            --industrial: #E1AA00;
            --black: #000000;
            --white: #ffffff;
            --shadow: 0 6px 18px rgba(0,0,0,0.08);
            --error: #dc2626;
            --success: #059669;
        }

        * {
            box-sizing: border-box;
        }

        html {
            /* Forzar que el viewport sea respetado en Apps Script */
            width: 100vw;
            max-width: 100vw;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }

        body {
            font-family: 'Poppins', 'Open Sans', Arial, sans-serif;
            background: var(--black);
            margin: 0;
            padding: 16px;
            color: var(--text);
            min-height: 100vh;
            /* Solución específica para Apps Script en móviles */
            width: 100vw;
            max-width: 100vw;
            overflow-x: hidden;
            position: relative;
            /* Evitar comportamientos extraños en iOS/Android dentro de webview */
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        /* Solución específica para contenedores de Google Apps Script */
        body.gs-mobile {
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
        }

        .wrap {
            max-width: 820px;
            margin: 0 auto;
            width: 100%;
            /* Asegurar que respete el contenedor padre */
            min-width: 0;
            overflow-x: hidden;
        }

        .card {
            background: var(--industrial);
            border-radius: 12px;
            padding: clamp(16px, 4vw, 22px);
            box-shadow: var(--shadow);
            border: 1px solid rgba(0,0,0,0.04);
            width: 100%;
            /* Asegurar que no se desborde en Apps Script */
            max-width: 100%;
            box-sizing: border-box;
        }

        .header {
            width: 100%;
            text-align: center;
            background: black;
            border-bottom: 4px solid var(--accent);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            padding: clamp(12px, 3vw, 20px);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .header .logo {
            width: 100%;
            max-width: 300px;
            height: auto;
            max-height: clamp(120px, 20vw, 180px);
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }

        .header h1 {
            margin: 0;
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            color: var(--industrial);
        }

        .header .lead {
            font-size: clamp(0.9rem, 2.5vw, 1rem);
            color: #555;
            margin-top: 0.5rem;
        }

        h1 {
            font-size: clamp(1.1rem, 3.5vw, 1.8rem);
            margin: 0;
            color: var(--black);
            line-height: 1.3;
        }

        p.lead {
            margin: 6px 0 12px 0;
            color: var(--muted);
            font-size: clamp(0.85rem, 2.2vw, 1rem);
        }

        #Inscripcion {
            text-align: center;
            margin: 16px 0;
            padding: 0 8px;
        }

        #Inscripcion h1 {
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            color: var(--black);
            margin-bottom: 8px;
        }

        #Inscripcion .lead {
            font-size: clamp(0.9rem, 2.5vw, 1rem);
            color: #555;
            margin-top: 0.5rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: clamp(8px, 2vw, 12px);
            width: 100%;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text);
            font-size: clamp(12px, 2.5vw, 14px);
            line-height: 1.4;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        select {
            width: 100%;
            padding: clamp(8px, 2vw, 12px);
            border-radius: 8px;
            border: 1px solid #d1d5db;
            background: #fff;
            font-size: clamp(12px, 2.5vw, 14px);
            line-height: 1.5;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            /* Asegurar que respeten el contenedor */
            max-width: 100%;
            box-sizing: border-box;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(243, 174, 0, 0.1);
        }

        .full {
            grid-column: 1 / -1;
        }

        .muted-small {
            font-size: clamp(10px, 2vw, 12px);
            color: var(--muted);
            margin-top: 6px;
            line-height: 1.4;
        }

        .radio-group, .checkbox-group {
            display: flex;
            gap: clamp(8px, 2vw, 12px);
            flex-wrap: wrap;
            align-items: flex-start;
        }

        .radio-group label, .checkbox-group label {
            font-weight: 400;
            color: var(--text);
            font-size: clamp(11px, 2.2vw, 13px);
            line-height: 1.4;
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .radio-group input[type="radio"],
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .firma-box {
            text-align: center;
            margin-top: 12px;
            width: 100%;
        }

        canvas {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: #fff;
            touch-action: none;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            /* Específico para evitar desbordamiento en Apps Script */
            box-sizing: border-box;
        }

        .btn {
            background: green;
            color: var(--white);
            border: none;
            padding: clamp(10px, 2.5vw, 12px) clamp(14px, 3vw, 18px);
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            font-size: clamp(13px, 2.8vw, 15px);
            transition: all 0.3s ease;
            width: 100%;
            max-width: 200px;
            margin: 0 auto;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn.secondary {
            background: #111827;
            color: var(--white);
            margin-top: 8px;
        }

        /* Selector de fecha personalizado */
        .date-selector {
            display: flex;
            gap: 8px;
            width: 100%;
        }

        .date-selector select {
            flex: 1;
            min-width: 0;
        }

        .date-selector .day-select {
            flex: 0.8;
        }

        .date-selector .month-select {
            flex: 1.2;
        }

        .date-selector .year-select {
            flex: 1;
        }

        /* Hidden input for form submission */
        #fecha_nacimiento_hidden {
            display: none;
        }

        /* Loader mejorado - Responsive */
        #loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
        }

        #loader .spinner {
            border: 6px solid #333;
            border-top: 6px solid var(--industrial);
            border-radius: 50%;
            width: clamp(40px, 8vw, 60px);
            height: clamp(40px, 8vw, 60px);
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        #loader .loader-text {
            color: var(--white);
            font-size: clamp(0.9rem, 3vw, 1.1rem);
            font-weight: 600;
            text-align: center;
            line-height: 1.4;
            max-width: 300px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Mensajes de confirmación y error - Responsive */
        .message-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 16px;
        }

        .message-box {
            background: var(--white);
            border-radius: 12px;
            padding: clamp(24px, 5vw, 40px);
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: messageSlideIn 0.3s ease-out;
            margin: 16px;
        }

        @keyframes messageSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .message-icon {
            font-size: clamp(2.5rem, 8vw, 4rem);
            margin-bottom: 20px;
        }

        .message-title {
            font-size: clamp(1.1rem, 4vw, 1.5rem);
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--black);
            line-height: 1.3;
        }

        .message-text {
            font-size: clamp(0.85rem, 2.8vw, 1rem);
            color: var(--muted);
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .message-success .message-icon {
            color: var(--success);
        }

        .message-error .message-icon {
            color: var(--error);
        }

        .message-btn {
            background: var(--industrial);
            color: var(--black);
            border: none;
            padding: clamp(10px, 2.5vw, 12px) clamp(20px, 4vw, 24px);
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: clamp(0.9rem, 2.5vw, 1rem);
            transition: all 0.3s ease;
            width: 100%;
            max-width: 200px;
        }

        .message-btn:hover {
            background: #c99700;
            transform: translateY(-1px);
        }

        footer.legal {
            margin-top: 18px;
            font-size: clamp(10px, 2vw, 12px);
            color: var(--muted);
            line-height: 1.4;
            padding: 0 8px;
        }

        .submit-container {
            margin-top: 16px;
            text-align: center;
            width: 100%;
        }

        /* Soluciones específicas para Google Apps Script en móviles */
        
        /* Detectar si estamos en un iframe (típico de Apps Script) */
        @media screen and (max-width: 768px) {
            /* Si estamos en móvil, asegurar que el contenido no se desborde */
            html {
                position: relative;
                width: 100% !important;
                max-width: 100% !important;
                overflow-x: hidden !important;
            }
            
            body {
                position: relative;
                width: 100% !important;
                max-width: 100% !important;
                overflow-x: hidden !important;
                padding: 8px !important;
            }
            
            .wrap {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .card {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                border-radius: 8px !important;
                box-sizing: border-box !important;
            }
        }

        /* Media queries específicas para mejor control */
        @media (max-width: 480px) {
            body {
                padding: 8px;
            }

            .card {
                padding: 16px;
            }

            .grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .header {
                padding: 16px;
            }

            #Inscripcion {
                margin: 12px 0;
            }

            canvas {
                width: 100%;
                max-width: 100%;
                height: 120px;
            }

            .radio-group, .checkbox-group {
                flex-direction: column;
                gap: 8px;
            }

            .radio-group label, .checkbox-group label {
                font-size: 12px;
                margin-bottom: 8px;
            }

            .btn {
                padding: 12px 16px;
                font-size: 14px;
                width: 100%;
                max-width: none;
            }

            .message-box {
                margin: 8px;
                padding: 24px 16px;
            }

            .date-selector {
                flex-direction: column;
                gap: 8px;
            }

            .date-selector select {
                flex: none;
            }
        }

        @media (min-width: 481px) and (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
                gap: 14px;
            }

            canvas {
                width: 100%;
                max-width: 500px;
                height: 140px;
            }

            .btn {
                max-width: 250px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }

            canvas {
                width: 100%;
                max-width: 560px;
                height: 160px;
            }
        }

        @media (min-width: 1025px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }

            canvas {
                width: 560px;
                height: 180px;
            }
        }

        /* Mejoras para accesibilidad y touch */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px;
                padding: 12px 18px;
            }

            input, select {
                min-height: 44px;
                font-size: 16px; /* Evita zoom en iOS */
            }

            .radio-group input[type="radio"],
            .checkbox-group input[type="checkbox"] {
                min-width: 20px;
                min-height: 20px;
            }
        }

        /* Orientación landscape en móviles */
        @media (max-height: 500px) and (orientation: landscape) {
            .message-box {
                max-height: 90vh;
                overflow-y: auto;
            }

            #loader .loader-text {
                font-size: 0.9rem;
            }

            canvas {
                height: 100px;
            }
        }

        /* Solución específica para webviews de Apps Script */
        @supports (-webkit-touch-callout: none) {
            /* iOS Safari/WebView específico */
            body {
                -webkit-overflow-scrolling: touch;
                position: relative;
            }
        }

        /* Forzar responsive en entornos embedded como Apps Script */
        @media screen and (max-device-width: 768px) {
            html, body {
                width: 100% !important;
                max-width: 100% !important;
                overflow-x: hidden !important;
            }
            
            .wrap, .card {
                width: 100% !important;
                max-width: 100% !important;
            }
        }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="card">
            <div class="header">
                <img src="https://raw.githubusercontent.com/sergicobo/Formularios_Inscripcion_Industrial_Training/main/LOGO_INDUSTRIAL.png" alt="Industrial Training" class="logo">
            </div>
            <div id="Inscripcion">
                <h1>Ficha de Inscripción - Industrial Training</h1>
                <p class="lead">Rellene todos los campos del formulario para completar la inscripción correctamente.</p>
            </div>

            <form id="formulario">
                <div class="grid">
                    <div>
                        <label>Nombre *</label>
                        <input name="nombre" type="text" required>
                    </div>
                    <div>
                        <label>Apellidos *</label>
                        <input name="apellidos" type="text" required>
                    </div>

                    <div class="full">
                        <label>DNI *</label>
                        <input name="dni" type="text" required placeholder="Ej: 12345678Z" maxlength="9">
                    </div>

                    <div>
                        <label>Fecha de nacimiento *</label>
                        <div class="date-selector">
                            <select id="birth_day" class="day-select" required>
                                <option value="">Día</option>
                            </select>
                            <select id="birth_month" class="month-select" required>
                                <option value="">Mes</option>
                                <option value="01">Enero</option>
                                <option value="02">Febrero</option>
                                <option value="03">Marzo</option>
                                <option value="04">Abril</option>
                                <option value="05">Mayo</option>
                                <option value="06">Junio</option>
                                <option value="07">Julio</option>
                                <option value="08">Agosto</option>
                                <option value="09">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                            <select id="birth_year" class="year-select" required>
                                <option value="">Año</option>
                            </select>
                        </div>
                        <input name="fecha_nacimiento" id="fecha_nacimiento_hidden" type="hidden" required>
                    </div>
                    <div>
                        <label>Teléfono *</label>
                        <input name="telefono" type="tel" required placeholder="Ej: 612 345 678 o 91 234 56 78" maxlength="20">
                    </div>

                    <div class="full">
                        <label>Dirección *</label>
                        <input name="direccion" type="text" required>
                    </div>
                    <div class="full">
                        <label>Calle 2 (opcional)</label>
                        <input name="direccion2" type="text">
                    </div>

                    <div>
                        <label>Ciudad *</label>
                        <input name="ciudad" type="text" required>
                    </div>
                    <div>
                        <label>Estado / Provincia *</label>
                        <input name="estado" type="text" required>
                    </div>

                    <div>
                        <label>Código Postal *</label>
                        <input name="cp" type="text" required>
                    </div>
                    <div>
                        <label>Email *</label>
                        <input name="email" type="email" required>
                    </div>

                    <div class="full">
                        <label>Cuota *</label>
                        <select name="cuota" required>
                            <option value="">Selecciona...</option>
                            <option>Bronce (55€/mes x 2 wods a la semana)</option>
                            <option>Plata (65€/mes x 3 wods a la semana)</option>
                            <option>Oro (75€/mes x 3 wods a la semana)</option>
                            <option>Diamante (85€/mes x clases ilimitadas)</option>
                            <option>Boxeo (65€/mes x clases ilimitadas)</option>
                            <option>Fusión (75€/mes x 2 wods y boxeo ilimitado)</option>
                            <option>KIDS (45€/mes x 1 Actividad)</option>
                            <option>KIDS DUO (65€/mes x 2 actividades)</option>
                        </select>
                    </div>

                    <div class="full">
                        <label>Autorización de derechos de imagen *</label>
                        <div class="radio-group">
                            <label><input type="radio" name="imagen" value="Si autorizo" required> Si autorizo a Industrial Training a captar y utilizar mi imagen (fotografías o vídeos) tomadas durante actividades o eventos del gimnasio, con fines informativos y/o promocionales en medios físicos o digitales del centro.</label>
                        </div>
                        <div class="radio-group">
                            <label><input type="radio" name="imagen" value="No autorizo" required> No autorizo mis derechos de imagen</label>
                        </div>
                    </div>

                    <div class="full">
                        <label>Opciones de pago *</label>
                        <div class="radio-group">
                            <label><input type="radio" name="pago" value="Domiciliación día 28" required> Domiciliación día 28</label>
                        </div>
                        <div class="radio-group">
                            <label><input type="radio" name="pago" value="Domiciliación día 5" required> Domiciliación día 5</label>
                        </div>
                        <div class="radio-group">
                            <label><input type="radio" name="pago" value="Efectivo" required> Efectivo (Máximo hasta el día 5 de cada mes)</label>
                        </div>
                        <p class="muted-small">
                            En caso de devolución del recibo, se cobrarán 8 € por costes bancarios. Si no se realiza el pago antes del día 5, el recibo se girará automáticamente. Si la deuda no se paga antes del día 8, la membresía se dará de baja y deberá reiniciarse la inscripción con los pagos correspondientes. La solicitud de baja deberá realizarse antes del día 25 de cada mes.
                        </p>
                    </div>

                    <div class="full">
                        <label>Número de cuenta IBAN *</label>
                        <input name="iban" type="text" required placeholder="Ej: ES12 1234 5678 9012 3456 7890" maxlength="34">
                        <p class="muted-small">
                            Autorizo a Industrial Training a gestionar los pagos de mis cuotas mediante domiciliación bancaria conforme a la normativa SEPA (Reglamento UE 260/2012). Declaro que los datos bancarios proporcionados son veraces y autorizo su uso exclusivo para este fin.
                        </p>
                    </div>

                    <div class="full">
                        <label>Fecha actual</label>
                        <input name="fecha_actual" id="fecha_actual" readonly>
                    </div>

                    <div class="full">
                        <label>Firma del cliente *</label>
                        <div class="firma-box">
                            <canvas id="firma" width="560" height="180"></canvas>
                            <button type="button" id="borrar" class="btn secondary">Borrar firma</button>
                            <p class="muted-small" style="margin-top: 8px;">
                                <strong>* Campo obligatorio:</strong> Firme en el recuadro superior para completar su inscripción.
                            </p>
                            <div class="radio-group">
                                <label><input type="radio" name="conditions" value="Aceptado" required> Declaro haber leído y aceptado las condiciones anteriores, así como las normas internas de Industrial Training.</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="submit-container">
                    <button type="submit" class="btn" id="submitBtn">Enviar inscripción</button>
                </div>

                <footer class="legal">
                    <p class="muted-small">
                        <strong>Protección de datos:</strong> De acuerdo con el Reglamento (UE) 2016/679 (RGPD) y la Ley Orgánica 3/2018 (LOPDGDD), se informa que el responsable del tratamiento de la información es Industrial Training, con la finalidad de gestionar inscripciones, cobros y actividades del gimnasio.
                    </p>
                </footer>
            </form>
        </div>
    </div>

    <!-- Loader mejorado -->
    <div id="loader">
        <div class="spinner"></div>
        <div class="loader-text">Procesando su inscripción...<br>Por favor, espere.</div>
    </div>

    <!-- Mensaje de éxito -->
    <div id="successMessage" class="message-container">
        <div class="message-box message-success">
            <div class="message-icon">✅</div>
            <div class="message-title">¡Inscripción Enviada Correctamente!</div>
            <div class="message-text">
                Gracias por registrarse en <strong>Industrial Training</strong>.<br>
                Su ficha de inscripción ha sido procesada exitosamente.<br>
                Nos pondremos en contacto con usted muy pronto.
            </div>
            <button class="message-btn" onclick="closeMessage('successMessage')">Entendido</button>
        </div>
    </div>

    <!-- Mensaje de error -->
    <div id="errorMessage" class="message-container">
        <div class="message-box message-error">
            <div class="message-icon">❌</div>
            <div class="message-title">Error al Enviar la Inscripción</div>
            <div class="message-text" id="errorText">
                Ha ocurrido un problema al procesar su inscripción.<br>
                Por favor, revise los datos e inténtelo nuevamente.
            </div>
            <button class="message-btn" onclick="closeMessage('errorMessage')">Intentar de Nuevo</button>
        </div>
    </div>

    <script>
        // Detectar si estamos en Google Apps Script y aplicar clases específicas
        function detectGoogleAppsScript() {
            // Verificar si estamos en un iframe (común en Apps Script)
            if (window !== window.top) {
                document.body.classList.add('gs-mobile');
            }
            
            // Verificar user agent para detectar webviews móviles
            const ua = navigator.userAgent.toLowerCase();
            if (ua.includes('wv') || ua.includes('webview') || window.GoogleAppsScript) {
                document.body.classList.add('gs-mobile');
            }
        }

        // Forzar viewport correcto en Apps Script
        function forceResponsiveViewport() {
            // Remover meta viewport existente si hay alguno
            const existingViewport = document.querySelector('meta[name="viewport"]');
            if (existingViewport) {
                existingViewport.remove();
            }
            
            // Agregar nuevo meta viewport optimizado para Apps Script
            const viewport = document.createElement('meta');
            viewport.name = 'viewport';
            viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover';
            document.head.appendChild(viewport);
            
            // Agregar meta tags adicionales para mejor comportamiento en móviles
            const webAppCapable = document.createElement('meta');
            webAppCapable.name = 'mobile-web-app-capable';
            webAppCapable.content = 'yes';
            document.head.appendChild(webAppCapable);
            
            const appleWebAppCapable = document.createElement('meta');
            appleWebAppCapable.name = 'apple-mobile-web-app-capable';
            appleWebAppCapable.content = 'yes';
            document.head.appendChild(appleWebAppCapable);
        }

        // Establecer fecha actual
        document.getElementById('fecha_actual').value = new Date().toLocaleDateString('es-ES');

        // Función para validar teléfono español (fijo o móvil)
        function validatePhone(phone) {
            // Eliminar espacios, guiones y otros caracteres no numéricos
            phone = phone.replace(/[\s\-\(\)\.]/g, '');

            // Verificar que solo contenga números y posibles prefijos
            if (!/^(\+34|0034|34)?[679][0-9]{8}$/.test(phone)) {
                // Si no coincide con móvil, verificar si es fijo
                if (!/^(\+34|0034|34)?[89][0-9]{8}$/.test(phone)) {
                    return {
                        valid: false,
                        error: 'Formato de teléfono incorrecto. Debe ser un móvil (6xx, 7xx, 9xx) o fijo (8xx, 9xx) válido'
                    };
                }
            }

            // Extraer solo los dígitos principales (sin prefijo)
            let cleanPhone = phone;
            if (phone.startsWith('+34')) {
                cleanPhone = phone.substring(3);
            } else if (phone.startsWith('0034')) {
                cleanPhone = phone.substring(4);
            } else if (phone.startsWith('34')) {
                cleanPhone = phone.substring(2);
            }

            // Verificar longitud (debe ser 9 dígitos)
            if (cleanPhone.length !== 9) {
                return {
                    valid: false,
                    error: 'El número de teléfono debe tener 9 dígitos'
                };
            }

            // Validar números móviles (6xx, 7xx, 9xx)
            if (cleanPhone.startsWith('6') || cleanPhone.startsWith('7')) {
                if (cleanPhone.length === 9) {
                    return { valid: true, type: 'móvil' };
                }
            }

            // Validar números fijos (8xx, 9xx pero no móviles)
            if (cleanPhone.startsWith('8') || (cleanPhone.startsWith('9') && !cleanPhone.startsWith('6') && !cleanPhone.startsWith('7'))) {
                if (cleanPhone.length === 9) {
                    return { valid: true, type: 'fijo' };
                }
            }

            // Validar números móviles que empiecen por 9xx (algunos rangos específicos)
            if (cleanPhone.startsWith('9')) {
                // Rangos móviles específicos que empiezan por 9
                const mobileRanges = ['900', '901', '902', '905', '906', '907'];
                const prefix = cleanPhone.substring(0, 3);
                if (mobileRanges.includes(prefix)) {
                    return { valid: true, type: 'móvil' };
                } else {
                    return { valid: true, type: 'fijo' };
                }
            }

            return {
                valid: false,
                error: 'Número de teléfono no válido. Debe comenzar por 6, 7, 8 o 9'
            };
        }

        // Función para formatear teléfono automáticamente
        function formatPhone(phone) {
            // Eliminar caracteres no numéricos excepto el +
            let cleaned = phone.replace(/[^\d\+]/g, '');

            // Si empieza con +34, mantenerlo
            if (cleaned.startsWith('+34')) {
                let numbers = cleaned.substring(3);
                if (numbers.length <= 9) {
                    return '+34 ' + numbers.replace(/(\d{3})(\d{3})(\d{3})/, '$1 $2 $3').trim();
                }
            }
            // Si empieza con 0034, convertir a +34
            else if (cleaned.startsWith('0034')) {
                let numbers = cleaned.substring(4);
                if (numbers.length <= 9) {
                    return '+34 ' + numbers.replace(/(\d{3})(\d{3})(\d{3})/, '$1 $2 $3').trim();
                }
            }
            // Si empieza con 34 (sin +), convertir a +34
            else if (cleaned.startsWith('34') && cleaned.length > 2) {
                let numbers = cleaned.substring(2);
                if (numbers.length <= 9) {
                    return '+34 ' + numbers.replace(/(\d{3})(\d{3})(\d{3})/, '$1 $2 $3').trim();
                }
            }
            // Si es un número español directo (9 dígitos)
            else if (cleaned.length <= 9) {
                return cleaned.replace(/(\d{3})(\d{3})(\d{3})/, '$1 $2 $3').trim();
            }

            return cleaned;
        }

        // Función para validar DNI español
        function validateDNI(dni) {
            // Eliminar espacios y convertir a mayúsculas
            dni = dni.replace(/\s/g, '').toUpperCase();

            // Verificar formato: 8 dígitos seguidos de una letra
            const dniRegex = /^[0-9]{8}[TRWAGMYFPDXBNJZSQVHLCKE]$/;
            if (!dniRegex.test(dni)) {
                return {
                    valid: false,
                    error: 'El DNI debe tener 8 dígitos seguidos de una letra (ej: 12345678Z)'
                };
            }

            // Extraer número y letra
            const number = parseInt(dni.substring(0, 8));
            const letter = dni.charAt(8);

            // Letras válidas para el cálculo del DNI
            const validLetters = 'TRWAGMYFPDXBNJZSQVHLCKE';
            const expectedLetter = validLetters[number % 23];

            if (letter !== expectedLetter) {
                return {
                    valid: false,
                    error: `La letra del DNI no es correcta. Para el número ${number}, la letra debería ser "${expectedLetter}"`
                };
            }

            return { valid: true };
        }

        // Función para validar IBAN
        function validateIBAN(iban) {
            // Eliminar espacios y convertir a mayúsculas
            iban = iban.replace(/\s/g, '').toUpperCase();

            // Verificar longitud mínima
            if (iban.length < 15) {
                return {
                    valid: false,
                    error: 'El IBAN es demasiado corto. Debe tener al menos 15 caracteres'
                };
            }

            // Verificar longitud máxima
            if (iban.length > 34) {
                return {
                    valid: false,
                    error: 'El IBAN es demasiado largo. No puede tener más de 34 caracteres'
                };
            }

            // Verificar formato básico (2 letras + 2 dígitos + alfanumérico)
            const ibanRegex = /^[A-Z]{2}[0-9]{2}[A-Z0-9]+$/;
            if (!ibanRegex.test(iban)) {
                return {
                    valid: false,
                    error: 'Formato de IBAN incorrecto. Debe comenzar con 2 letras del país, seguidas de 2 dígitos de control y los dígitos de cuenta'
                };
            }

            // Validación específica para España (ES)
            if (iban.startsWith('ES')) {
                if (iban.length !== 24) {
                    return {
                        valid: false,
                        error: 'Para cuentas españolas, el IBAN debe tener exactamente 24 caracteres (ej: ES12 1234 5678 9012 3456 7890)'
                    };
                }
            }

            // Algoritmo de validación IBAN
            function mod97(str) {
                let remainder = '';
                for (let i = 0; i < str.length; i++) {
                    remainder = (remainder + str.charAt(i));
                    if (remainder.length >= 9) {
                        remainder = (parseInt(remainder) % 97).toString();
                    }
                }

                return parseInt(remainder) % 97;
            }

            // Mover los primeros 4 caracteres al final
            const rearranged = iban.substring(4) + iban.substring(0, 4);

            // Convertir letras a números (A=10, B=11, ..., Z=35)
            let numericString = '';
            for (let i = 0; i < rearranged.length; i++) {
                const char = rearranged.charAt(i);
                if (char >= 'A' && char <= 'Z') {
                    numericString += (char.charCodeAt(0) - 'A'.charCodeAt(0) + 10).toString();
                } else {
                    numericString += char;
                }
            }

            // Verificar que el resto de la división entre 97 es 1
            const checkResult = mod97(numericString);
            if (checkResult !== 1) {
                return {
                    valid: false,
                    error: 'El número IBAN no es válido. Los dígitos de control no coinciden. Verifique que ha introducido correctamente todos los números'
                };
            }

            return { valid: true };
        }

        // Agregar validaciones en tiempo real
        function setupValidations() {
            const dniInput = document.querySelector('input[name="dni"]');
            const ibanInput = document.querySelector('input[name="iban"]');
            const phoneInput = document.querySelector('input[name="telefono"]');

            // Validación DNI en tiempo real
            if (dniInput) {
                // Formatear DNI automáticamente
                dniInput.addEventListener('input', function () {
                    let value = this.value.replace(/[^0-9a-zA-Z]/g, '').toUpperCase();
                    if (value.length > 9) value = value.substring(0, 9);
                    this.value = value;
                    this.setCustomValidity('');
                });

                dniInput.addEventListener('blur', function () {
                    const dniValue = this.value.trim();
                    if (dniValue) {
                        const validation = validateDNI(dniValue);
                        if (!validation.valid) {
                            this.setCustomValidity(validation.error);
                        } else {
                            this.setCustomValidity('');
                        }
                    }
                });
            }

            // Validación teléfono en tiempo real
            if (phoneInput) {
                // Formatear teléfono automáticamente
                phoneInput.addEventListener('input', function () {
                    const formatted = formatPhone(this.value);
                    this.value = formatted;
                    this.setCustomValidity('');
                });

                phoneInput.addEventListener('blur', function () {
                    const phoneValue = this.value.trim();
                    if (phoneValue) {
                        const validation = validatePhone(phoneValue);
                        if (!validation.valid) {
                            this.setCustomValidity(validation.error);
                        } else {
                            this.setCustomValidity('');
                        }
                    }
                });
            }

            // Validación IBAN en tiempo real
            if (ibanInput) {
                // Formatear IBAN automáticamente (agregar espacios cada 4 caracteres)
                ibanInput.addEventListener('input', function () {
                    let value = this.value.replace(/[^0-9a-zA-Z]/g, '').toUpperCase();
                    let formatted = '';
                    for (let i = 0; i < value.length; i++) {
                        if (i > 0 && i % 4 === 0) {
                            formatted += ' ';
                        }
                        formatted += value[i];
                    }
                    this.value = formatted;
                    this.setCustomValidity('');
                });

                ibanInput.addEventListener('blur', function () {
                    const ibanValue = this.value.trim();
                    if (ibanValue) {
                        const validation = validateIBAN(ibanValue);
                        if (!validation.valid) {
                            this.setCustomValidity(validation.error);
                        } else {
                            this.setCustomValidity('');
                        }
                    }
                });
            }
        }

        // Inicializar selector de fecha de nacimiento
        function initBirthDateSelector() {
            const daySelect = document.getElementById('birth_day');
            const monthSelect = document.getElementById('birth_month');
            const yearSelect = document.getElementById('birth_year');
            const hiddenInput = document.getElementById('fecha_nacimiento_hidden');

            // Poblar días (1-31)
            for (let i = 1; i <= 31; i++) {
                const option = document.createElement('option');
                option.value = i.toString().padStart(2, '0');
                option.textContent = i;
                daySelect.appendChild(option);
            }

            // Poblar años (desde 1930 hasta año currentYear)
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= 1930; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }

            // Función para actualizar el input hidden
            function updateHiddenInput() {
                const day = daySelect.value;
                const month = monthSelect.value;
                const year = yearSelect.value;

                if (day && month && year) {
                    // Validar que la fecha sea válida
                    const date = new Date(year, parseInt(month) - 1, parseInt(day));
                    if (date.getFullYear() == year &&
                        date.getMonth() == parseInt(month) - 1 &&
                        date.getDate() == parseInt(day)) {
                        hiddenInput.value = `${year}-${month}-${day}`;
                        hiddenInput.setCustomValidity('');
                    } else {
                        hiddenInput.value = '';
                        hiddenInput.setCustomValidity('Fecha no válida');
                    }
                } else {
                    hiddenInput.value = '';
                    hiddenInput.setCustomValidity('Fecha de nacimiento requerida');
                }
            }

            // Función para actualizar días según mes y año
            function updateDays() {
                const month = parseInt(monthSelect.value);
                const year = parseInt(yearSelect.value);
                const currentDay = daySelect.value;

                // Limpiar opciones de días
                daySelect.innerHTML = '<option value="">Día</option>';

                if (month && year) {
                    // Calcular días del mes
                    const daysInMonth = new Date(year, month, 0).getDate();

                    for (let i = 1; i <= daysInMonth; i++) {
                        const option = document.createElement('option');
                        option.value = i.toString().padStart(2, '0');
                        option.textContent = i;
                        daySelect.appendChild(option);
                    }

                    // Restaurar día seleccionado si es válido
                    if (currentDay && parseInt(currentDay) <= daysInMonth) {
                        daySelect.value = currentDay;
                    }
                } else {
                    // Mostrar todos los días si no hay mes/año seleccionado
                    for (let i = 1; i <= 31; i++) {
                        const option = document.createElement('option');
                        option.value = i.toString().padStart(2, '0');
                        option.textContent = i;
                        daySelect.appendChild(option);
                    }
                    if (currentDay) {
                        daySelect.value = currentDay;
                    }
                }

                updateHiddenInput();
            }

            // Event listeners
            daySelect.addEventListener('change', updateHiddenInput);
            monthSelect.addEventListener('change', () => {
                updateDays();
            });
            yearSelect.addEventListener('change', () => {
                updateDays();
            });

            // Inicializar validación
            updateHiddenInput();
        }

        // Inicializar selector cuando se carga la página
        document.addEventListener('DOMContentLoaded', function () {
            initBirthDateSelector();
            setupValidations();
        });

        // También ejecutar cuando se carga la ventana como respaldo
        window.addEventListener('load', function () {
            // Solo ejecutar si no se ha inicializado ya
            const daySelect = document.getElementById('birth_day');
            if (daySelect && daySelect.children.length <= 1) {
                initBirthDateSelector();
            }
            setupValidations();
        });

        // Funciones para manejar mensajes
        function showMessage(messageId) {
            document.getElementById(messageId).style.display = 'flex';
        }

        function closeMessage(messageId) {
            document.getElementById(messageId).style.display = 'none';
            if (messageId === 'successMessage') {
                // Resetear formulario después de éxito
                document.getElementById('formulario').reset();
                // Limpiar firma
                const canvas = document.getElementById('firma');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                // Restaurar fecha
                document.getElementById('fecha_actual').value = new Date().toLocaleDateString('es-ES');
                // Resetear selector de fecha de nacimiento
                document.getElementById('birth_day').selectedIndex = 0;
                document.getElementById('birth_month').selectedIndex = 0;
                document.getElementById('birth_year').selectedIndex = 0;
                document.getElementById('fecha_nacimiento_hidden').value = '';
                // Limpiar validaciones personalizadas
                const dniInput = document.querySelector('input[name="dni"]');
                const ibanInput = document.querySelector('input[name="iban"]');
                const phoneInput = document.querySelector('input[name="telefono"]');
                if (dniInput) dniInput.setCustomValidity('');
                if (ibanInput) ibanInput.setCustomValidity('');
                if (phoneInput) phoneInput.setCustomValidity('');
            }
        }

        // Ajustar canvas según el tamaño de pantalla - Mejorado para Apps Script
        function adjustCanvas() {
            const canvas = document.getElementById('firma');
            const container = canvas.parentElement;
            const containerWidth = container.offsetWidth;
            const deviceWidth = window.innerWidth || document.documentElement.clientWidth;
            
            // Usar device width si es menor que container width (típico en Apps Script)
            const availableWidth = Math.min(containerWidth - 20, deviceWidth - 40);
            
            if (deviceWidth <= 480) {
                canvas.width = Math.min(availableWidth, 300);
                canvas.height = 120;
            } else if (deviceWidth <= 768) {
                canvas.width = Math.min(availableWidth, 480);
                canvas.height = 140;
            } else if (deviceWidth <= 1024) {
                canvas.width = Math.min(availableWidth, 540);
                canvas.height = 160;
            } else {
                canvas.width = 560;
                canvas.height = 180;
            }
            
            // Asegurar que el canvas respete el contenedor padre
            if (canvas.width > availableWidth) {
                canvas.width = availableWidth;
            }
        }

        // Inicialización cuando se carga el DOM
        document.addEventListener('DOMContentLoaded', function() {
            detectGoogleAppsScript();
            forceResponsiveViewport();
            initBirthDateSelector();
            adjustCanvas();
        });

        // También ejecutar cuando se carga la ventana como respaldo
        window.addEventListener('load', function() {
            detectGoogleAppsScript();
            adjustCanvas();
            
            // Solo ejecutar si no se ha inicializado ya
            const daySelect = document.getElementById('birth_day');
            if (daySelect && daySelect.children.length <= 1) {
                initBirthDateSelector();
            }
        });

        // Ajustar canvas al redimensionar
        window.addEventListener('resize', adjustCanvas);

        // Funcionalidad de firma mejorada para Apps Script
        (function () {
            const canvas = document.getElementById('firma');
            const ctx = canvas.getContext('2d');
            let drawing = false;
            let lastX = 0, lastY = 0;

            function start(e) {
                e.preventDefault(); // Prevenir comportamientos por defecto
                drawing = true;
                [lastX, lastY] = getXY(e);
                ctx.beginPath();
            }
            
            function end(e) {
                e.preventDefault();
                drawing = false;
                ctx.beginPath();
            }
            
            function draw(e) {
                e.preventDefault();
                if (!drawing) return;
                const [x, y] = getXY(e);
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.strokeStyle = '#111';
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                [lastX, lastY] = [x, y];
            }
            
            function getXY(e) {
                const rect = canvas.getBoundingClientRect();
                if (e.touches && e.touches.length) {
                    return [
                        (e.touches[0].clientX - rect.left) * (canvas.width / rect.width),
                        (e.touches[0].clientY - rect.top) * (canvas.height / rect.height)
                    ];
                } else {
                    return [
                        (e.clientX - rect.left) * (canvas.width / rect.width),
                        (e.clientY - rect.top) * (canvas.height / rect.height)
                    ];
                }
            }

            // Event listeners mejorados para touch y mouse
            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('touchstart', start, { passive: false });
            
            window.addEventListener('mouseup', end);
            canvas.addEventListener('touchend', end, { passive: false });
            
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('touchmove', draw, { passive: false });

            document.getElementById('borrar').addEventListener('click', function () {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            });

            // Manejo del envío del formulario
            const form = document.getElementById('formulario');
            const loader = document.getElementById('loader');
            const submitBtn = document.getElementById('submitBtn');

            form.addEventListener('submit', function (e) {
                e.preventDefault();

                // Validaciones personalizadas antes del envío
                const dniInput = document.querySelector('input[name="dni"]');
                const ibanInput = document.querySelector('input[name="iban"]');
                const phoneInput = document.querySelector('input[name="telefono"]');

                // Validar DNI
                if (dniInput && dniInput.value.trim()) {
                    const dniValidation = validateDNI(dniInput.value.trim());
                    if (!dniValidation.valid) {
                        document.getElementById('errorText').innerHTML =
                            '<strong>DNI Incorrecto:</strong><br>' +
                            dniValidation.error + '<br><br>' +
                            'Por favor, revise el DNI introducido y asegúrese de que sea válido.';
                        showMessage('errorMessage');
                        return;
                    }
                }

                // Validar teléfono
                if (phoneInput && phoneInput.value.trim()) {
                    const phoneValidation = validatePhone(phoneInput.value.trim());
                    if (!phoneValidation.valid) {
                        document.getElementById('errorText').innerHTML =
                            '<strong>Teléfono Incorrecto:</strong><br>' +
                            phoneValidation.error + '<br><br>' +
                            'Por favor, introduzca un número de teléfono válido (móvil o fijo).';
                        showMessage('errorMessage');
                        return;
                    }
                }

                // Validar IBAN (siempre obligatorio)
                if (!ibanInput || !ibanInput.value.trim()) {
                    document.getElementById('errorText').innerHTML =
                        '<strong>IBAN Requerido:</strong><br>' +
                        'El número de cuenta IBAN es obligatorio independientemente del método de pago seleccionado.<br><br>' +
                        'Según las condiciones de la empresa, si no se recibe el pago por el método seleccionado, se realizará el cobro automáticamente por domiciliación bancaria.';
                    showMessage('errorMessage');
                    return;
                }

                const ibanValidation = validateIBAN(ibanInput.value.trim());
                if (!ibanValidation.valid) {
                    document.getElementById('errorText').innerHTML =
                        '<strong>IBAN Incorrecto:</strong><br>' +
                        ibanValidation.error + '<br><br>' +
                        'Por favor, revise el número IBAN introducido. Asegúrese de incluir el código del país y todos los dígitos.';
                    showMessage('errorMessage');
                    return;
                }

                // Validar que la firma esté presente
                const canvas = document.getElementById('firma');
                const ctx = canvas.getContext('2d');

                // Verificar si el canvas tiene contenido (no está en blanco)
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const pixelData = imageData.data;
                let hasContent = false;


                // Revisar si hay algún pixel que no sea transparente
                for (let i = 3; i < pixelData.length; i += 4) {
                    if (pixelData[i] !== 0) { // Alpha channel diferente de 0
                        hasContent = true;
                        break;
                    }
                }

                if (!hasContent) {
                    // Mostrar error si no hay firma
                    document.getElementById('errorText').innerHTML =
                        '<strong>Firma requerida:</strong><br>' +
                        'Por favor, firme en el recuadro antes de enviar el formulario.<br><br>' +
                        'La firma es obligatoria para completar la inscripción.';
                    showMessage('errorMessage');
                    return;
                }

                // Mostrar loader y deshabilitar botón
                loader.style.display = 'flex';
                submitBtn.disabled = true;
                submitBtn.textContent = 'Enviando...';

                const dataUrl = canvas.toDataURL('image/png');
                const formData = new FormData(form);
                formData.append('firma', dataUrl);

                const scriptURL = 'https://script.google.com/macros/s/AKfycbx8BWMBA-X5rQERw-GxxISXfYYPzdbamSBWGQmHjanwUZkGYCcj6znYNkGSqSbZeOUCVg/exec';

                fetch(scriptURL, { method: 'POST', body: formData })
                    .then(r => r.text())
                    .then(txt => {
                        // Ocultar loader y restaurar botón
                        loader.style.display = 'none';
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Enviar inscripción';

                        if (txt && txt.startsWith('OK')) {
                            showMessage('successMessage');
                        } else {
                            // Mostrar error con detalles
                            document.getElementById('errorText').innerHTML =
                                'Ha ocurrido un problema al procesar su inscripción.<br>' +
                                '<strong>Detalles del error:</strong><br>' +
                                (txt || 'Error desconocido') + '<br><br>' +
                                'Por favor, revise los datos e inténtelo nuevamente.';
                            showMessage('errorMessage');
                        }
                    })
                    .catch(err => {
                        // Ocultar loader y restaurar botón
                        loader.style.display = 'none';
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Enviar inscripción';

                        // Mostrar error de conexión
                        document.getElementById('errorText').innerHTML =
                            'Error de conexión al enviar el formulario.<br>' +
                            '<strong>Detalles:</strong><br>' + err.message + '<br><br>' +
                            'Por favor, verifique su conexión a internet e inténtelo nuevamente.';
                        showMessage('errorMessage');
                    });
            });
        })();
    </script>
</body>
</html>